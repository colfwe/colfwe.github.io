* åœ¨Linuxä¸Šç¼–è¯‘emacs-feature-igcåˆ†æ”¯çš„ä¸ªäººæ–¹æ³•

** åŸºæœ¬ä»‹ç»

*** ä»€ä¹ˆæ˜¯ igcï¼Ÿä»€ä¹ˆæ˜¯ mpsï¼Ÿ

é¦–å…ˆåœ¨ ~çœŸ-lisp~ çš„ç¼–ç¨‹è¯­è¨€ï¼Œéƒ½æ˜¯è‡ªå¸¦äº†ä¸€ä¸ª *GC åƒåœ¾å›æ”¶æœºåˆ¶*

#+begin_src 
æ¯”å¦‚ schemeã€common lispã€elisp è¿™äº› lisp æ–¹è¨€ï¼Œéƒ½è‡ªå¸¦äº† GC åƒåœ¾å›æ”¶æœºåˆ¶
#+end_src

ç„¶è€Œåœ¨ ~mock-lisp(ä¼ª-lisp)~ çš„ç¼–ç¨‹è¯­è¨€ä¸‹å°± *æ²¡æœ‰GCåƒåœ¾å›æ”¶æœºåˆ¶*

#+begin_src
æ¯”å¦‚Rustå†™çš„ä¸€ä¸ªewwæ¡Œé¢ç»„ä»¶ï¼Œå°±æ˜¯ç”¨çš„ [yuck] è¿™é—¨ä¼ªlispç¼–ç¨‹è¯­è¨€å»ç¼–å†™ç»“æ„çš„
#+end_src

é‚£ä¹ˆè¿™æ ·ä¸€æ¥ï¼Œæˆ‘ä»¬çš„GNU Emacsç”¨çš„æ˜¯elispï¼Œæ‰€ä»¥æˆ‘ä»¬çš„GNU Emacså°±å¤©ç”Ÿå°±æœ‰äº†GCæœºåˆ¶ï¼Ÿ

#+begin_src  
å¯¹å•Šï¼GNU Emacså®ƒå¤©ç”Ÿå°±æœ‰GCæœºåˆ¶  
#+end_src

ç„¶åæœ‰äº›ä½¬ï¼Œå«Œè¿™ä¸ªGNU Emacsçš„GCæœºåˆ¶æ§åˆ¶å¾—ä¸å¤Ÿè‡ªç”±ï¼Œäºæ˜¯å°±ç¡¬æ˜¯ç”¨Cppé‡æ–°é€ äº†ä¸€ä¸ª ~æ–°çš„GCæœºåˆ¶ çš„ The (M)emory (P)ool (S)ystem~ å‡ºæ¥

äºæ˜¯è¿™ä¸ª *æ–°çš„GCæœºåˆ¶ å°±ç§°å‘¼ä¸º (I)ncremental GC* 

è¯­ä¹‰ä¸º ~å¢é‡GCï¼ŒDelta GC~ çš„æ„æ€ï¼Œç®€ç§°I-G-Cï¼Œæ‰€ä»¥æœ€åç®€ç§°igc

å®ƒç”¨åˆ°çš„åº“æ–‡ä»¶ï¼Œå«åš The (M)emory (P)ool (S)ystem çš„ mps æ‰€ä»¥ä¸€ä¼šè¦å®‰è£… libmps å°±æ˜¯è¿™ä¹ˆæ¥çš„


** å®‰è£…æ–¹æ³•

#+begin_src
BYDï¼Œæ£€æµ‹ libmps.h çš„ ./configure checking æŠ˜ç£¨äº†æˆ‘è´¼ä¹…  
#+end_src

*** libmpsåº“æ–‡ä»¶çš„å®‰è£…

#+begin_src 
libmpså¤§è‡´ä¿¡æ¯
  
.a é™æ€æ–‡ä»¶éƒ¨åˆ†
   ğŸ”§ libmps.a
   ğŸ”§ libmps-debug.a
.h å¤´æ–‡ä»¶éƒ¨åˆ†
   ğŸ”§ mpsacl.h
   ğŸ”§ mpsavm.h
   ğŸ”§ mpscamc.h
   ğŸ”§ mpscams.h
   ğŸ”§ mpscawl.h
   ğŸ”§ mpsclo.h
   ğŸ”§ mpscmfs.h
   ğŸ”§ mpscmv2.h
   ğŸ”§ mpscmvff.h
   ğŸ”§ mpscmvt.h
   ğŸ”§ mpscsnc.h
   ğŸ”§ mps.h
   ğŸ”§ mpsio.h
   ğŸ”§ mpslib.h
   ğŸ”§ mpstd.h
   ğŸ”§ mpswin.h
#+end_src

éœ€è¦å®‰è£…homebrewæ¥å®‰è£…libmpsï¼Œå¦‚æœä¸æƒ³å®‰è£…homebrewçš„è¯ï¼Œ[[https://github.com/colfwe/dotfiles/tree/main/libmps][æ­¤ä»“åº“]] é‡Œä¹Ÿæœ‰ _2023å¹´7æœˆ11æ—¥å‘å¸ƒçš„1.118.0ç‰ˆçš„Releaseç‰ˆæœ¬_

#+begin_src sh
  # é¦–å…ˆåœ¨ Linux ä¸Šå®‰è£… homebrew

  
  # å®‰è£…2023å¹´ç‰ˆçš„1.118.0ç‰ˆçš„mps
  brew install libmps

  # å®‰è£…æœ€æ–°ç‰ˆçš„mps
  brew install libmps --HEAD  
#+end_src

éšåå¯ä»¥åœ¨ ~/home/linuxbrew/.linuxbrew/Cellar çš„ /libmps/1.118.0/~ ä¸‹å¾—åˆ°libmpsçš„æ–‡ä»¶

ç„¶åå†å°† libmps æ”¾åˆ°linuxç³»ç»Ÿçº§çš„ç›®å½•ä¸‹ï¼Œå°±å®Œæˆäº†libmpsçš„å®‰è£…

#+begin_src sh
  # å¾ˆæŠ±æ­‰æˆ‘è¯´å¾—è¿™ä¹ˆç»å¯¹ï¼Œä½†å¿…é¡»è¦å¤åˆ¶åˆ°ç³»ç»Ÿçº§çš„/usr/libä¸/usr/include
  # è¿™æ˜¯æˆ‘ç¢°å£æ— æ•°æ¬¡åå¾—å‡ºçš„ [å”¯ä¸€] æœ€ç»ˆè§£å†³åšæ³•
  # å› ä¸ºç¼–è¯‘emacsæ—¶æ·»åŠ å…³äºlibmpsæ–‡ä»¶çš„CFLAGSä¸LDFLAGSé€‰é¡¹åœ¨æˆ‘è¿™é‡Œæ˜¯æ²¡æœ‰ä»»ä½•æ•ˆæœçš„ï¼    

  sudo cp *.h /usr/include
  sudo cp *.a /usr/lib
#+end_src
  
*** emacs-feature-igcçš„ç¼–è¯‘é€‰é¡¹

ç‚¹å‡»ç›´è¾¾: [[https://github.com/emacs-mirror/emacs/tree/feature/igc][emacs-feature-igc]]

è€Œä¸”æ¨è: ~6654ac61342a0a2ffef50435d026cae09314ad5c~  è¿™ä¸ªæäº¤ç‚¹çš„emacs [[https://github.com/emacs-mirror/emacs/tree/6654ac61342a0a2ffef50435d026cae09314ad5c][ç‚¹å‡»ç›´è¾¾]]ï¼Œå› ä¸ºè¿è¡Œååˆ†ç¨³å®šï¼Œåœ¨ [æˆ‘ä¸ªäººçš„é…ç½®ä¸Š] åœ¨éé…ç½®æƒ…å†µä¸‹ä¸€æ¬¡ä¹Ÿæ²¡æœ‰å´©æºƒè¿‡

å…ˆè¿è¡Œ ~autogen.sh~ ä»è€Œå¾—åˆ° ~configure~

ç„¶åå†ç›´æ¥è¿è¡Œï¼Œæ¥è®© ~./configure~ è·å¾—ç›¸å…³çš„ ~ç¼–è¯‘é€‰é¡¹: option~
#+begin_src sh
CFLAGS="-fmax-errors=1000" ./configure --sysconfdir=/etc --prefix=/usr --libexecdir=/usr/lib --with-tree-sitter=ifavailable --localstatedir=/var --disable-build-details --with-harfbuzz --with-libsystemd --with-modules --with-x-toolkit=no --with-mps=yes 'CFLAGS=-march=x86-64 -mtune=generic -O2 -pipe -fno-plt -fexceptions -Wp,-D_FORTIFY_SOURCE=3 -Wformat -Werror=format-security -fstack-clash-protection -fcf-protection -fno-omit-frame-pointer -mno-omit-leaf-frame-pointer -g -ffile-prefix-map=/build/emacs/src=/usr/src/debug/emacs -flto=auto' 'LDFLAGS=-Wl,-O1 -Wl,--sort-common -Wl,--as-needed -Wl,-z,relro -Wl,-z,now -Wl,-z,pack-relative-relocs -flto=auto'  
#+end_src

ç„¶åç­‰å¾…é…ç½®å®Œæˆå°±è¡Œäº†

- *æœŸé—´ä¸€å®šè¦æ³¨æ„: å¿…é¡»æ˜¯ mps.hâ€¦..yesï¼Œä¸èƒ½æ˜¯The libmps is missingï¼æ‰ç®—è¯†åˆ«åˆ°mpsåº“æ–‡ä»¶ï¼ï¼*
- *æœŸé—´ä¸€å®šè¦æ³¨æ„: å¿…é¡»æ˜¯ mps.hâ€¦..yesï¼Œä¸èƒ½æ˜¯The libmps is missingï¼æ‰ç®—è¯†åˆ«åˆ°mpsåº“æ–‡ä»¶ï¼ï¼*  
- *æœŸé—´ä¸€å®šè¦æ³¨æ„: å¿…é¡»æ˜¯ mps.hâ€¦..yesï¼Œä¸èƒ½æ˜¯The libmps is missingï¼æ‰ç®—è¯†åˆ«åˆ°mpsåº“æ–‡ä»¶ï¼ï¼*

*** æ£€éªŒæ˜¯å¦å®‰è£…æˆåŠŸ

è¿›å…¥GNU Emacsåï¼Œæ‰§è¡Œ ~M-x igc-stats~ å¹¶åœ¨æ‰“å¼€çš„æ–°bufferä¸Šï¼ŒæŒ‰ ~wasd~ çš„ ~s~

å¦‚æœèƒ½å‡ºç°

#+begin_src
IGC_OBJ_BLV                                854           40992         48            48
IGC_OBJ_BUILTIN_SUBR                         0               0          0             0
IGC_OBJ_BUILTIN_SYMBOL                       0               0          0             0
IGC_OBJ_BUILTIN_THREAD                       0               0          0             0
IGC_OBJ_BYTES                                0               0          0             0
IGC_OBJ_CONS                           1876951        45046824         24            24
.......................................................................................  
#+end_src

è¿™æ ·çš„æç¤ºæ–‡å­—ï¼Œå°±èƒ½è¯´æ˜ mps èµ·æ•ˆæœäº†ï¼

å¦‚æœæ˜¯ ~The Symbol igc-stats is void~ çš„è¯ï¼Œé‚£ä¹ˆ *ä¸€å®šæ˜¯ä½ è‡ªå·±åœ¨ emacs-feature-igc åˆ†æ”¯æºç åŒ…ä¸‹çš„ ./configure å†…ï¼Œæ²¡æœ‰è®©å®ƒè¯†åˆ«åˆ°libmpsåº“æ–‡ä»¶ï¼è¯·ä½ è‡ªå·±é‡æ–°æŸ¥çœ‹æ–‡æ¡£å®‰è£…ï¼*


